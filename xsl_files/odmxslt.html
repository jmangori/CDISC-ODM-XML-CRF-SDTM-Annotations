<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Light adoptation from Martin Honnen. Thanks a lot.
     https://github.com/martin-honnen/martin-honnen.github.io/blob/master/xslt/arcor-archive/2016/test2016081501.html
     Removed attempt to support Internet Explorer, as it don't understand Promise, and is outdated and unsafe anyway
-->
<script>
  function loadDoc(url) {
    return new Promise(function(resolve) {
      var req = new XMLHttpRequest();
      req.open("GET", url);
      req.onload = function() {
        resolve(this.responseXML)
      }
      req.send();
    });
  }

  function transform(xmlUrl, xslUrl, targetElement) {
    Promise.all([loadDoc(xmlUrl), loadDoc(xslUrl)]).then(function(data) {
      var xmlDoc = data[0];
      var xslDoc = data[1];

      var proc = new XSLTProcessor();
      proc.importStylesheet(xslDoc);

      proc.setParameter(null, "parmanno",    params["parmanno"]);
      proc.setParameter(null, "parmname",    params["parmname"]);
      proc.setParameter(null, "parmlogo",    params["parmlogo"]);
      proc.setParameter(null, "parmstudy",   params["parmstudy"]);
      proc.setParameter(null, "parmsite",    params["parmsite"]);
      proc.setParameter(null, "parminv",     params["parminv"]);
      proc.setParameter(null, "parmsubject", params["parmsubject"]);
      proc.setParameter(null, "parminit",    params["parminit"]);
      proc.setParameter(null, "parmvisit",   params["parmvisit"]);
      var resultFrag = proc.transformToFragment(xmlDoc, targetElement.ownerDocument);

      targetElement.textContent = '';
      targetElement.appendChild(resultFrag);
    });
  }

  function getParams(){
    var idx = document.URL.indexOf('?');
    var params = new Array();
    if (idx != -1) {
      var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
      for (var i=0; i<pairs.length; i++){
          nameVal = pairs[i].split('=');
          params[nameVal[0]] = nameVal[1].replace(/\+/g, " ");
      }
    }
    return params;
  }

  params  = getParams();

  document.addEventListener('DOMContentLoaded', function() {
    transform(params["parmxml"], params["parmxsl"], document.documentElement);
  })

</script>
